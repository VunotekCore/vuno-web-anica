---
// Contact form component with two options: Quote Project or Schedule Meeting
---

<section class="mx-auto max-w-4xl">
    <div class="rounded-lg border-2 border-primary/30 bg-gray-50 p-2 shadow-xl">
        <!-- Form Type Selector -->
        <div class="mb-8 flex gap-4">
            <button
                type="button"
                id="btn-cotizar"
                class="form-type-btn active hover:bg-primary/90 flex-1 rounded-lg border-2 border-primary bg-primary px-6 py-3 font-bold text-white transition-all"
            >
                Cotizar Proyecto
            </button>
            <button
                type="button"
                id="btn-agendar"
                class="form-type-btn hover:bg-primary/10 flex-1 rounded-lg border-2 border-primary bg-transparent px-6 py-3 font-bold text-primary transition-all"
            >
                Agendar Reunión
            </button>
        </div>

        <!-- Contact Form -->
        <form id="contact-form" class="space-y-6">
            <input
                type="hidden"
                id="form-type"
                name="formType"
                value="cotizar"
            />

            <!-- Common Fields -->
            <div class="grid gap-6 md:grid-cols-2">
                <div>
                    <label for="name" class="mb-2 block font-semibold">
                        Nombre Completo <span class="text-primary">*</span>
                    </label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        required
                        class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-neutral transition-colors focus:border-primary focus:outline-none"
                        placeholder="Juan Pérez"
                    />
                </div>

                <div>
                    <label for="email" class="mb-2 block font-semibold">
                        Email <span class="text-primary">*</span>
                    </label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-neutral transition-colors focus:border-primary focus:outline-none"
                        placeholder="juan@empresa.com"
                    />
                </div>
            </div>

            <div class="grid gap-6 md:grid-cols-2">
                <div>
                    <label for="phone" class="mb-2 block font-semibold">
                        Teléfono <span class="text-primary">*</span>
                    </label>
                    <input
                        type="tel"
                        id="phone"
                        name="phone"
                        required
                        class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-neutral transition-colors focus:border-primary focus:outline-none"
                        placeholder="+505 8888-8888"
                    />
                </div>

                <div>
                    <label for="company" class="mb-2 block font-semibold">
                        Empresa
                    </label>
                    <input
                        type="text"
                        id="company"
                        name="company"
                        class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-neutral transition-colors focus:border-primary focus:outline-none"
                        placeholder="Mi Empresa S.A."
                    />
                </div>
            </div>

            <!-- Cotizar Fields -->
            <div id="cotizar-fields" class="space-y-6">
                <div>
                    <label for="project-type" class="mb-2 block font-semibold">
                        Tipo de Proyecto <span class="text-primary">*</span>
                    </label>
                    <select
                        id="project-type"
                        name="projectType"
                        class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-neutral transition-colors focus:border-primary focus:outline-none"
                    >
                        <option value="">Seleccione una opción</option>
                        <option value="medios_visuales"
                            >Medios Visuales & Promocionales</option
                        >
                        <option value="modelado_3d"
                            >Modelado 3D & Renderizado</option
                        >
                        <option value="web_aplicaciones"
                            >Web & Aplicaciones</option
                        >
                        <option value="muebles_comerciales"
                            >Muebles Comerciales & Hogar</option
                        >
                        <option value="otro">Otro</option>
                    </select>
                </div>

                <div>
                    <label for="budget" class="mb-2 block font-semibold">
                        Presupuesto Estimado
                    </label>
                    <select
                        id="budget"
                        name="budget"
                        class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-neutral transition-colors focus:border-primary focus:outline-none"
                    >
                        <option value="">Seleccione un rango</option>
                        <option value="1k-5k">$1,000 - $5,000</option>
                        <option value="5k-10k">$5,000 - $10,000</option>
                        <option value="10k-15k">$10,000 - $15,000</option>
                        <option value="15k+">$15,000+</option>
                    </select>
                </div>

                <div>
                    <label for="timeline" class="mb-2 block font-semibold">
                        Tiempo Estimado de Entrega
                    </label>
                    <select
                        id="timeline"
                        name="timeline"
                        class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-neutral transition-colors focus:border-primary focus:outline-none"
                    >
                        <option value="">Seleccione un plazo</option>
                        <option value="1-month">1 mes</option>
                        <option value="1-3-months">1-3 meses</option>
                        <option value="3-6-months">3-6 meses</option>
                        <option value="6-months+">Más de 6 meses</option>
                    </select>
                </div>
            </div>

            <!-- Agendar Fields -->
            <div id="agendar-fields" class="hidden space-y-6">
                <div class="grid gap-6 md:grid-cols-2">
                    <div>
                        <label
                            for="preferred-date"
                            class="mb-2 block font-semibold"
                        >
                            Fecha Preferida <span class="text-primary">*</span>
                        </label>
                        <input
                            type="date"
                            id="preferred-date"
                            name="preferredDate"
                            class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-neutral transition-colors focus:border-primary focus:outline-none"
                        />
                    </div>

                    <div>
                        <label
                            for="preferred-time"
                            class="mb-2 block font-semibold"
                        >
                            Hora Preferida <span class="text-primary">*</span>
                        </label>
                        <select
                            id="preferred-time"
                            name="preferredTime"
                            class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-neutral transition-colors focus:border-primary focus:outline-none"
                        >
                            <option value="">Seleccione una hora</option>
                            <option value="9am">9:00 AM</option>
                            <option value="10am">10:00 AM</option>
                            <option value="11am">11:00 AM</option>
                            <option value="2pm">2:00 PM</option>
                            <option value="3pm">3:00 PM</option>
                            <option value="4pm">4:00 PM</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="meeting-type" class="mb-2 block font-semibold">
                        Tipo de Reunión <span class="text-primary">*</span>
                    </label>
                    <select
                        id="meeting-type"
                        name="meetingType"
                        class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-neutral transition-colors focus:border-primary focus:outline-none"
                    >
                        <option value="">Seleccione una opción</option>
                        <option value="virtual">Virtual (Zoom/Meet)</option>
                        <option value="presencial">Presencial</option>
                        <option value="phone">Llamada Telefónica</option>
                    </select>
                </div>
            </div>

            <!-- Message Field (Common) -->
            <div>
                <label for="message" class="mb-2 block font-semibold">
                    Mensaje <span class="text-primary">*</span>
                </label>
                <textarea
                    id="message"
                    name="message"
                    required
                    rows="5"
                    class="w-full rounded-lg border-2 border-default bg-default px-4 py-3 text-default transition-colors focus:border-primary focus:outline-none"
                    placeholder="Cuéntanos más sobre tu proyecto o los temas que deseas discutir..."
                ></textarea>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center">
                <button
                    type="submit"
                    class="hover:bg-primary/90 rounded-lg bg-primary px-12 py-4 font-bold text-white transition-all hover:shadow-lg"
                >
                    <span id="submit-text">Enviar Cotización</span>
                </button>
            </div>
        </form>

        <!-- Success Message -->
        <div
            id="success-message"
            class="bg-primary/20 mt-6 hidden rounded-lg p-6 text-center"
        >
            <p class="font-semibold text-primary text-lg">
                ¡Gracias por contactarnos! Nos pondremos en contacto contigo
                pronto.
            </p>
        </div>
    </div>
</section>

<script is:inline>
    // Form type switching
    function initContactForm() {
        const btnCotizar = document.getElementById("btn-cotizar");
        const btnAgendar = document.getElementById("btn-agendar");
        const cotizarFields = document.getElementById("cotizar-fields");
        const agendarFields = document.getElementById("agendar-fields");
        const formTypeInput = document.getElementById("form-type");
        const submitText = document.getElementById("submit-text");

        function switchToQuote() {
            btnCotizar?.classList.add("active", "bg-primary", "text-white");
            btnCotizar?.classList.remove("bg-transparent", "text-primary");
            btnAgendar?.classList.remove("active", "bg-primary", "text-white");
            btnAgendar?.classList.add("bg-transparent", "text-primary");
            cotizarFields?.classList.remove("hidden");
            agendarFields?.classList.add("hidden");
            if (formTypeInput) formTypeInput.value = "cotizar";
            if (submitText) submitText.textContent = "Enviar Cotización";

            // Update required fields
            document
                .getElementById("project-type")
                ?.setAttribute("required", "required");
            document
                .getElementById("preferred-date")
                ?.removeAttribute("required");
            document
                .getElementById("preferred-time")
                ?.removeAttribute("required");
            document
                .getElementById("meeting-type")
                ?.removeAttribute("required");
        }

        function switchToSchedule() {
            btnAgendar?.classList.add("active", "bg-primary", "text-white");
            btnAgendar?.classList.remove("bg-transparent", "text-primary");
            btnCotizar?.classList.remove("active", "bg-primary", "text-white");
            btnCotizar?.classList.add("bg-transparent", "text-primary");
            agendarFields?.classList.remove("hidden");
            cotizarFields?.classList.add("hidden");
            if (formTypeInput) formTypeInput.value = "agendar";
            if (submitText) submitText.textContent = "Agendar Reunión";

            // Update required fields
            document
                .getElementById("project-type")
                ?.removeAttribute("required");
            document
                .getElementById("preferred-date")
                ?.setAttribute("required", "required");
            document
                .getElementById("preferred-time")
                ?.setAttribute("required", "required");
            document
                .getElementById("meeting-type")
                ?.setAttribute("required", "required");
        }

        btnCotizar?.addEventListener("click", (e) => {
            e.preventDefault();
            switchToQuote();
        });

        btnAgendar?.addEventListener("click", (e) => {
            e.preventDefault();
            switchToSchedule();
        });

        // Check URL hash on load
        if (window.location.hash === "#agendar") {
            switchToSchedule();
        } else if (window.location.hash === "#cotizar") {
            switchToQuote();
        }

        // Form submission
        const form = document.getElementById("contact-form");
        const successMessage = document.getElementById("success-message");
        const submitButton = form?.querySelector('button[type="submit"]');

        form?.addEventListener("submit", async (e) => {
            e.preventDefault();

            // deshabilitar boton durante  el envio
            if (submitButton) {
                submitButton.disable /= true;
                const originalText = submitText?.textContent;
                if (submitText) {
                    submitText.textContent = "Enviando...";
                }
            }

            try {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                const apiBaseUrl =
                    window.location.hostname === "localhost"
                        ? "http://localhost:8000"
                        : "https://anicasolucionesintegrales.com";

                const emailResponse = await fetch(
                    `${apiBaseUrl}/api/send-email.php`,
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    },
                );

                const emailResult = await emailResponse.json();

                if (!emailResult.success) {
                    throw new Error(
                        emailResult.message || "Error al enviar el mensaje",
                    );
                }

                // si es una reuninon tambien se crea el evento en calendario
                if (data.formType === "agendar") {
                    try {
                        const calendarResponse = await fetch(
                            `${apiBaseUrl}/api/calendar-handler.php`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(data),
                            },
                        );
                        const calendarResult = await calendarResponse.json();

                        if (calendarResult.success) {
                            console.log(
                                "Evento de calendario creado:",
                                calendarResult.event,
                            );
                        } else {
                            console.warn(
                                "No se pudo crear el evento de calendario",
                                calendarResult.message,
                            );
                        }
                        // no se lanza error el email si se envia
                    } catch (calendarError) {
                        console.warn(
                            "Error al crear el evento de calendario",
                            calendarError,
                        );
                    }
                }
                // mostrar mensaje de exito
                form.classList.add("hidden");
                successMessage?.classList.remove("hidden");

                // resetear el formulario despues de 5 segundos
                setTimeout(() => {
                    form.reset();
                    form.classList.remove("hidden");
                    successMessage?.classList.add("hidden");
                    switchToQuote(); // reset to defaullt

                    // rehabilitar boton
                    if (submitButton) {
                        submitButton.disabled = false;
                        if (submitText) {
                            submitText.textContent = "Enviar Cotización";
                        }
                    }
                }, 5000);
            } catch (error) {
                console.error("Error al enviar el formulario:", error);
                // mostrar mensaje de error al usuario
                alert(
                    "Error al enviar formulario: " +
                        error.message +
                        "\n\nPor favor intenta nuevamente o contactanos directamente.",
                );

                // Rehabilitar boton
                if (submitButton) {
                    submitButton.disabled = false;
                    const formType = formTypeInput?.value || "Cotizar";
                    if (submitText) {
                        submitText.textContent =
                            formType === "Agendar"
                                ? "Agendar Reunión"
                                : "Enviar Cotización";
                    }
                }
            }
        });
    }

    // Run initialization when DOM is ready
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initContactForm);
    } else {
        initContactForm();
    }
</script>

<style>
    .form-type-btn {
        cursor: pointer;
    }
</style>
